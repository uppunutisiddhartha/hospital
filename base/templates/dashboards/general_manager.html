<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>GM Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --light-bg: #f8f9fa;
            --card-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        body { background-color: var(--light-bg); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .dashboard-header { background: linear-gradient(135deg, var(--primary-color), #34495e); color:white; border-radius:10px; padding:1.5rem; margin-bottom:2rem; box-shadow: var(--card-shadow);}
        .dashboard-title { font-weight:700; letter-spacing:0.5px; }
        .card { border:none; border-radius:10px; box-shadow:var(--card-shadow); transition: transform 0.3s ease;}
        .card:hover { transform: translateY(-5px);}
        .card-header { border-radius:10px 10px 0 0 !important; font-weight:600; padding:1rem 1.25rem; }
        .table td, .table th { vertical-align: middle; padding:1rem; }
        .status-badge { font-size:0.85rem; padding:6px 12px; border-radius:20px; font-weight:600; }
        .btn-create-post { background: linear-gradient(to right, var(--secondary-color), #2980b9); border:none; border-radius:6px; padding:10px 24px; font-weight:600; box-shadow:0 4px 10px rgba(52,152,219,0.3); transition: all 0.3s ease;}
        .btn-create-post:hover { transform:translateY(-2px); box-shadow:0 6px 15px rgba(52,152,219,0.4);}
        .post-image-preview { width:60px; height:60px; object-fit:cover; border-radius:6px; border:1px solid #dee2e6; }
        .action-dropdown { width:120px; cursor:pointer; }
        .stats-card { text-align:center; padding:1.5rem 1rem; border-radius:10px; color:white; margin-bottom:1.5rem; }
        .stats-card.published { background: linear-gradient(135deg, var(--success-color), #2ecc71);}
        .stats-card.pending { background: linear-gradient(135deg, var(--warning-color), #e67e22);}
        .stats-card.total { background: linear-gradient(135deg, var(--secondary-color), #2980b9);}
        .stats-number { font-size:2.2rem; font-weight:700; margin-bottom:0.5rem; }
        .modal-content { border-radius:10px; border:none;}
        .modal-header { background-color: var(--primary-color); color:white; border-radius:10px 10px 0 0; }
        .close { color:white; opacity:0.8; }
        .close:hover { color:white; opacity:1; }
        .form-control:focus { border-color:var(--secondary-color); box-shadow:0 0 0 0.2rem rgba(52,152,219,0.25);}
        .post-date { font-size:0.85rem; color:#6c757d;}
        .table-hover tbody tr:hover { background-color: rgba(52,152,219,0.05);}
        @media (max-width:768px){ .stats-card { margin-bottom:1rem; } .table-responsive { border:none; } }
    </style>
</head>

<body>
<div class="container py-4">

    <!-- HEADER -->
    <div class="dashboard-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="dashboard-title mb-1">General Manager Dashboard</h2>
                <p class="mb-0">Create, manage, and publish posts</p>
            </div>
            <button type="button" class="btn btn-create-post" data-toggle="modal" data-target="#createPostModal">
                <i class="fas fa-plus-circle mr-2"></i>Create New Post
            </button>
        </div>
    </div>

    <!-- STATISTICS -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="stats-card total">
                <div class="stats-number" id="totalPosts">{{ posts|length }}</div>
                <div>Total Posts</div>
                <i class="fas fa-file-alt fa-2x mt-2"></i>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stats-card published">
                <div class="stats-number" id="publishedPosts">{{ published_count|default:0 }}</div>
                <div>Published</div>
                <i class="fas fa-check-circle fa-2x mt-2"></i>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stats-card pending">
                <div class="stats-number" id="pendingPosts">{{ pending_count|default:0 }}</div>
                <div>On Hold</div>
                <i class="fas fa-pause-circle fa-2x mt-2"></i>
            </div>
        </div>
    </div>

    <!-- POSTS TABLE -->
    <div class="card">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
            <span><i class="fas fa-list mr-2"></i>Posts Management</span>
            <span class="badge badge-light">{{ posts|length }} posts</span>
        </div>
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="thead-light">
                    <tr>
                        <th width="40%">Title</th>
                        <th width="25%">Status</th>
                        <th width="20%">Date</th>
                        <th width="15%">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for post in posts %}
                    <tr id="postRow{{ post.id }}">
                        <td>
                            <div class="d-flex align-items-center">
                                {% if post.image %}
                                    <img src="{{ post.image.url }}" class="post-image-preview mr-3">
                                {% else %}
                                    <div class="post-image-preview mr-3 d-flex align-items-center justify-content-center bg-light">
                                        <i class="fas fa-image text-muted"></i>
                                    </div>
                                {% endif %}
                                <div>
                                    <strong>{{ post.title|truncatechars:40 }}</strong>
                                    <strong>{{ post. }}</strong>

                                    <div class="post-date">ID: {{ post.id }}</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            {% if post.status == 'publish' %}
                                <span class="badge badge-success status-badge"><i class="fas fa-check-circle mr-1"></i>Published</span>
                            {% else %}
                                <span class="badge badge-warning status-badge"><i class="fas fa-pause-circle mr-1"></i>On Hold</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="post-date">{% if post.created_at %}{{ post.created_at|date:"M d, Y" }}{% else %}Recently{% endif %}</div>
                        </td>
                        
                        <td>
                           <form method="post" action="{% url 'gm_update_post_status' post.id %}" class="status-form" data-post-id="{{ post.id }}">
                                {% csrf_token %}
                                <select name="action" class="form-control form-control-sm action-dropdown">
                                    <option value="hold" {% if post.status == 'hold' %}selected{% endif %}>
                                        Hold
                                    </option>
                                    <option value="publish" {% if post.status == 'publish' %}selected{% endif %}>
                                        Publish
                                    </option>
                                </select>
                            </form>
                            <a href="{% url 'delete_post' post.id %}" onclick="return confirm('Are you sure you want to delete this post?');" class="btn btn-sm btn-outline-danger mt-2">
                                <i class="fas fa-trash"></i> Delete
                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" class="text-center text-muted py-5">
                            <i class="fas fa-inbox fa-3x mb-3"></i>
                            <h5>No posts created yet</h5>
                            <p>Click "Create New Post" to get started</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- CREATE POST MODAL -->
<div class="modal fade" id="createPostModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-plus-circle mr-2"></i>Create New Post</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <form method="post" enctype="multipart/form-data" id="postForm">
                    {% csrf_token %}
                    <input type="hidden" name="form_type" value="create">

                    <div class="form-group">
                        <label>Title *</label>
                        <input type="text" name="title" class="form-control" placeholder="Enter post title" required>
                    </div>

                    <div class="form-group">
                        <label>Image *</label>
                        <input type="file" name="image" class="form-control-file" id="postImage" required>
                        <div class="mt-2" id="imagePreviewContainer" style="display:none;">
                            <img id="imagePreview" class="img-fluid rounded" style="max-height:200px;">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Content *</label>
                        <textarea name="content" class="form-control" rows="5" placeholder="Write post content..." required></textarea>
                    </div>

                    <div class="form-group">
                        <label>Initial Status</label>
                        <select name="initial_status" class="form-control">
                            <option value="hold">On Hold</option>
                            <option value="publish">Publish Immediately</option>
                        </select>
                    </div>

                    <button type="submit" class="btn btn-primary px-4 mt-2">
                        <i class="fas fa-paper-plane mr-2"></i>Create Post
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    document.getElementById('postImage')?.addEventListener('change', function(e){
        const file = e.target.files[0];
        const preview = document.getElementById('imagePreview');
        const container = document.getElementById('imagePreviewContainer');
        if(file){
            const reader = new FileReader();
            reader.onload = e => { preview.src = e.target.result; container.style.display='block'; };
            reader.readAsDataURL(file);
        } else { container.style.display='none'; }
    });

    document.querySelectorAll('.action-dropdown').forEach(dd=>{
        dd.addEventListener('change',function(){
            this.closest('.status-form').submit();
        });
    });
</script>
</body>
</html>
