{% load static %}
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Content Manager | Pioneer Hospitals</title>

    <!-- Bootstrap 5 -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" /> 
    <link rel="stylesheet" href="{% static 'base/dashboards/general_manager.css' %}" />
  </head>
  <body>
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Dashboard Container -->
    <div class="dashboard-container">
      <!-- Header -->
      <header class="dashboard-header">
        <div class="header-content">
          <div class="header-left">
            <h1>Content Management Dashboard</h1>
            <p>Manage, publish, and track all posts in real-time</p>
          </div>
          <div class="header-right">
            <div class="user-profile" onclick="showUserMenu()">
              <div class="user-avatar">
                <span>GM</span>
              </div>
              <div class="user-info">
                <h4>General Manager</h4>
                <p>Administrator</p>
              </div>
              <i class="fas fa-chevron-down"></i>
            </div>
          </div>
        </div>
      </header>

      <!-- Stats Grid -->
      <section class="stats-grid">
        <div class="stat-card total fade-in">
          <div class="stat-content">
            <div class="stat-numbers">
              <div class="stat-value">{{ posts|length }}</div>
              <div class="stat-label">
                <i class="fas fa-file-alt"></i>
                Total Posts
              </div>
              <div class="stat-change positive">
                <i class="fas fa-arrow-up"></i>
                <span>Live updating</span>
              </div>
            </div>
            <div class="stat-icon">
              <i class="fas fa-layer-group"></i>
            </div>
          </div>
        </div>

        <div class="stat-card published fade-in" style="animation-delay: 0.1s">
          <div class="stat-content">
            <div class="stat-numbers">
              <div class="stat-value">{{ published_count|default:0 }}</div>
              <div class="stat-label">
                <i class="fas fa-check-circle"></i>
                Published
              </div>
              <div class="stat-change">
                {{ published_percentage|default:"0" }}% of total
              </div>
            </div>
            <div class="stat-icon">
              <i class="fas fa-check-circle"></i>
            </div>
          </div>
        </div>
        <div class="stat-card published fade-in" style="animation-delay: 0.1s">
          <div class="stat-content">
            <div class="stat-numbers">
              <div class="stat-value">{{ newsletter_subscribe }}</div>
              <div class="stat-label">
                <i class="fas fa-check-circle"></i>
                Active Subscribers
              </div>
              <div class="stat-change">
                {{ newsletter_percentage|default:"0" }}% of total
              </div>
            </div>
            <div class="stat-icon">
              <i class="fas fa-check-circle"></i>
            </div>
          </div>
        </div>

        <div class="stat-card hold fade-in" style="animation-delay: 0.2s">
          <div class="stat-content">
            <div class="stat-numbers">
              <div class="stat-value">{{ pending_count|default:0 }}</div>
              <div class="stat-label">
                <i class="fas fa-pause-circle"></i>
                On Hold
              </div>
              <div class="stat-change">
                {{ pending_percentage|default:"0" }}% of total
              </div>
            </div>
            <div class="stat-icon">
              <i class="fas fa-pause-circle"></i>
            </div>
          </div>
        </div>

        <div class="stat-card draft fade-in" style="animation-delay: 0.3s">
          <div class="stat-content">
            <div class="stat-numbers">
              <div class="stat-value">{{ draft_count|default:0 }}</div>
              <div class="stat-label">
                <i class="fas fa-edit"></i>
                In Draft
              </div>
              <div class="stat-change">Ready for review</div>
            </div>
            <div class="stat-icon">
              <i class="fas fa-edit"></i>
            </div>
          </div>
        </div>
      </section>

      <!-- Main Content -->
      <main class="main-content">
        <!-- Quick Actions -->
        <div class="quick-actions">
          <button
            class="action-btn fade-in"
            data-bs-toggle="modal"
            data-bs-target="#createPostModal"
          >
            <i class="fas fa-plus-circle"></i>
            <div class="action-btn-content">
              <h4>Create New Post</h4>
              <p>Start a new article with media</p>
            </div>
          </button>

          <button
            class="action-btn fade-in"
            style="animation-delay: 0.1s"
            onclick="refreshDashboard()"
          >
            <i class="fas fa-sync-alt"></i>
            <div class="action-btn-content">
              <h4>Refresh Data</h4>
              <p>Update all statistics</p>
            </div>
          </button>

          <button
            class="action-btn fade-in"
            style="animation-delay: 0.2s"
            onclick="exportData()"
          >
            <i class="fas fa-download"></i>
            <div class="action-btn-content">
              <h4>Export Reports</h4>
              <p>Download CSV/PDF reports</p>
            </div>
          </button>

          <button
            class="action-btn fade-in"
            style="animation-delay: 0.3s"
            onclick="showAllPosts()"
          >
            <i class="fas fa-eye"></i>
            <div class="action-btn-content">
              <h4>View All Posts</h4>
              <p>{{ posts|length }} total articles</p>
            </div>
          </button>
        </div>

        <!-- Filter Bar -->
        <div class="filter-bar fade-in">
          <div class="filter-grid">
            <div class="search-box">
              <i class="fas fa-search"></i>
              <input
                type="text"
                class="form-control"
                id="searchInput"
                placeholder="Search posts by title, content, or ID..."
              />
            </div>

            <select class="filter-select" id="statusFilter">
              <option value="all">All Status</option>
              <option value="publish">Published Only</option>
              <option value="hold">On Hold</option>
              <option value="draft">Drafts</option>
            </select>

            <select class="filter-select" id="sortFilter">
              <option value="newest">Newest First</option>
              <option value="oldest">Oldest First</option>
              <option value="title">Title A-Z</option>
            </select>
          </div>
        </div>

        <!-- Posts Table -->
        <div class="table-container fade-in">
          <div class="table-header">
            <h3 class="table-title">
              <i class="fas fa-list"></i>
              Posts Management
            </h3>
            <span
              class="badge bg-primary"
              style="padding: 10px 20px; font-size: 1rem"
            >
              {{ posts|length }} Posts
            </span>
          </div>

          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Post</th>
                  <th>Status</th>
                  <th>Created</th>
                  <th>Last Updated</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="postsTableBody">
                {% for post in posts %}
                <tr
                  class="post-row"
                  data-status="{{ post.status }}"
                  data-id="{{ post.id }}"
                >
                  <td>
                    <div class="post-preview">
                      <div class="post-thumbnail">
                        {% if post.image %}
                        <img
                          src="{{ post.image.url }}"
                          alt="{{ post.title }}"
                        />
                        {% else %}
                        <div
                          style="
                            width: 100%;
                            height: 100%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            background: #f0f0f0;
                            color: #ccc;
                          "
                        >
                          <i class="fas fa-image"></i>
                        </div>
                        {% endif %}
                      </div>
                      <div class="post-info">
                        <h4 class="post-title">{{ post.title }}</h4>
                        <div class="post-meta">
                          <span
                            ><i class="fas fa-hashtag"></i> ID: {{ post.id
                            }}</span
                          >
                          <span
                            ><i class="fas fa-font"></i> {{ post.content|length
                            }} chars</span
                          >
                          <span
                            ><i class="far fa-clock"></i> {{
                            post.content|wordcount|divisibleby:200|add:1 }} min
                            read</span
                          >
                        </div>
                      </div>
                    </div>
                  </td>
                  <td>
                    {% if post.status == 'publish' %}
                    <span class="status-badge status-published">
                      <i class="fas fa-check-circle"></i>
                      Published
                    </span>
                    {% elif post.status == 'hold' %}
                    <span class="status-badge status-hold">
                      <i class="fas fa-pause-circle"></i>
                      On Hold
                    </span>
                    {% else %}
                    <span class="status-badge status-draft">
                      <i class="fas fa-edit"></i>
                      Draft
                    </span>
                    {% endif %}
                  </td>
                  <td>
                    <div style="font-weight: 600; color: var(--dark)">
                      {{ post.created_at|date:"M d, Y" }}
                    </div>
                    <div style="font-size: 0.9rem; color: var(--gray-600)">
                      {{ post.created_at|time:"H:i" }}
                    </div>
                  </td>
                  <td>
                    <div style="font-weight: 600; color: var(--dark)">
                      {{ post.updated_at|date:"M d, Y"|default:"Recently" }}
                    </div>
                    <div style="font-size: 0.9rem; color: var(--gray-600)">
                      Updated
                    </div>
                  </td>
                  <td>
                    <div class="action-buttons">
                      {% if post.status != 'publish' %}
                      <form
                        method="post"
                        action="{% url 'gm_update_post_status' post.id %}"
                        class="d-inline"
                      >
                        {% csrf_token %}
                        <button
                          type="submit"
                          name="action"
                          value="publish"
                          class="btn-action btn-publish"
                        >
                          <i class="fas fa-rocket"></i>
                          Publish
                        </button>
                      </form>
                      {% endif %} {% if post.status != 'hold' %}
                      <form
                        method="post"
                        action="{% url 'gm_update_post_status' post.id %}"
                        class="d-inline"
                      >
                        {% csrf_token %}
                        <button
                          type="submit"
                          name="action"
                          value="hold"
                          class="btn-action btn-hold"
                        >
                          <i class="fas fa-pause"></i>
                          Hold
                        </button>
                      </form>
                      {% endif %}

                      <button
                        class="btn-action btn-edit"
                        onclick="editPost({{ post.id }})"
                      >
                        <i class="fas fa-edit"></i>
                        Edit
                      </button>

                      <form
                        method="post"
                        action="{% url 'delete_post' post.id %}"
                        class="d-inline"
                        onsubmit="return confirmDelete();"
                      >
                        {% csrf_token %}
                        <button type="submit" class="btn-action btn-delete">
                          <i class="fas fa-trash"></i>
                          Delete
                        </button>
                      </form>
                    </div>
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="5">
                    <div class="empty-state">
                      <div class="empty-state-icon">
                        <i class="fas fa-inbox"></i>
                      </div>
                      <h3>No posts found</h3>
                      <p>
                        Create your first post to get started with content
                        management
                      </p>
                      <button
                        class="btn-action btn-publish"
                        data-bs-toggle="modal"
                        data-bs-target="#createPostModal"
                      >
                        <i class="fas fa-plus-circle"></i>
                        Create Your First Post
                      </button>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

        <!-- Charts Section -->
        <div class="charts-section">
          <div class="chart-card fade-in">
            <h3 class="chart-title">Post Distribution</h3>
            <div style="height: 300px; position: relative">
              <canvas id="postsChart"></canvas>
            </div>
          </div>

          <div class="chart-card fade-in" style="animation-delay: 0.2s">
            <h3 class="chart-title">Activity Summary</h3>
            <div style="display: grid; gap: 20px; margin-top: 20px">
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  padding: 20px;
                  background: var(--gray-100);
                  border-radius: 12px;
                "
              >
                <div>
                  <div style="font-size: 0.9rem; color: var(--gray-600)">
                    Posts Created Today
                  </div>
                  <div
                    style="
                      font-size: 1.8rem;
                      font-weight: 700;
                      color: var(--dark);
                    "
                  >
                    {{ today_posts|default:0 }}
                  </div>
                </div>
                <i
                  class="fas fa-calendar-plus"
                  style="color: var(--primary); font-size: 2rem"
                ></i>
              </div>

              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  padding: 20px;
                  background: var(--gray-100);
                  border-radius: 12px;
                "
              >
                <div>
                  <div style="font-size: 0.9rem; color: var(--gray-600)">
                    Posts This Week
                  </div>
                  <div
                    style="
                      font-size: 1.8rem;
                      font-weight: 700;
                      color: var(--dark);
                    "
                  >
                    {{ week_posts|default:0 }}
                  </div>
                </div>
                <i
                  class="fas fa-chart-line"
                  style="color: var(--success); font-size: 2rem"
                ></i>
              </div>

              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  padding: 20px;
                  background: var(--gray-100);
                  border-radius: 12px;
                "
              >
                <div>
                  <div style="font-size: 0.9rem; color: var(--gray-600)">
                    All subscribed users
                  </div>
                  <div
                    style="
                      font-size: 1.8rem;
                      font-weight: 700;
                      color: var(--dark);
                    "
                  >
                    {{ newsletter_subscribe |default:0 }}
                  </div>
                </div>
                <i
                  class="fas fa-tachometer-alt"
                  style="color: var(--warning); font-size: 2rem"
                ></i>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- Create Post Modal -->
    <div
      class="modal fade"
      id="createPostModal"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="fas fa-plus-circle me-2"></i>
              Create New Post
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form
              method="post"
              action=""
              enctype="multipart/form-data"
              id="postForm"
            >
              {% csrf_token %}
              <input type="hidden" name="form_type" value="create" />

              <div class="form-group">
                <label class="form-label fw-bold">Title *</label>
                <input
                  type="text"
                  name="title"
                  class="form-control form-control-lg"
                  placeholder="Enter a compelling title..."
                  required
                />
                <div class="form-text">
                  Keep it under 60 characters for best results
                </div>
              </div>

              <div class="form-group">
                <label class="form-label fw-bold">Featured Image *</label>
                <div class="input-group">
                  <input
                    type="file"
                    name="image"
                    class="form-control"
                    id="postImage"
                    accept="image/*"
                    required
                    onchange="previewImage(event)"
                  />
                </div>
                <div
                  class="mt-3 text-center"
                  id="imagePreviewContainer"
                  style="display: none"
                >
                  <img
                    id="imagePreview"
                    class="img-fluid rounded"
                    style="max-height: 250px; border: 3px dashed #dee2e6"
                  />
                </div>
              </div>

              <div class="form-group">
                <label class="form-label fw-bold">Content *</label>
                <textarea
                  name="content"
                  class="form-control"
                  rows="8"
                  placeholder="Write your content here..."
                  required
                ></textarea>
                <div class="form-text">Minimum 100 characters recommended</div>
              </div>

              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label class="form-label fw-bold">Initial Status</label>
                    <select name="initial_status" class="form-control">
                      <option value="draft">Save as Draft</option>
                      <option value="hold">Save and Hold</option>
                      <option value="publish">Publish Immediately</option>
                    </select>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label class="form-label fw-bold"
                      >Category (Optional)</label
                    >
                    <input
                      type="text"
                      name="category"
                      class="form-control"
                      placeholder="e.g., Announcement, Update"
                    />
                  </div>
                </div>
              </div>

              <div class="d-flex justify-content-between mt-4">
                <button
                  type="button"
                  class="btn btn-outline-secondary"
                  data-bs-dismiss="modal"
                >
                  <i class="fas fa-times me-2"></i>Cancel
                </button>
                <button type="submit" class="btn btn-primary px-4">
                  <i class="fas fa-paper-plane me-2"></i>Create Post
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // Initialize Chart
      function initializeChart() {
          const ctx = document.getElementById('postsChart').getContext('2d');
          const chart = new Chart(ctx, {
              type: 'doughnut',
              data: {
                  labels: ['Published', 'On Hold', 'Draft'],
                  datasets: [{
                      data: [
                          {{ published_count|default:0 }},
                          {{ pending_count|default:0 }},
                          {{ draft_count|default:0 }}
                      ],
                      backgroundColor: [
                          '#06d6a0',
                          '#ffd166',
                          '#6c757d'
                      ],
                      borderWidth: 3,
                      borderColor: '#ffffff',
                      hoverOffset: 15
                  }]
              },
              options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                      legend: {
                          position: 'bottom',
                          labels: {
                              padding: 25,
                              usePointStyle: true,
                              font: {
                                  size: 14
                              }
                          }
                      },
                      tooltip: {
                          callbacks: {
                              label: function(context) {
                                  const label = context.label || '';
                                  const value = context.raw || 0;
                                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                  const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                  return `${label}: ${value} (${percentage}%)`;
                              }
                          }
                      }
                  }
              }
          });
      }

      // Image Preview
      function previewImage(event) {
          const input = event.target;
          const preview = document.getElementById('imagePreview');
          const container = document.getElementById('imagePreviewContainer');

          if (input.files && input.files[0]) {
              const reader = new FileReader();
              reader.onload = function(e) {
                  preview.src = e.target.result;
                  container.style.display = 'block';
              }
              reader.readAsDataURL(input.files[0]);
          }
      }

      // Toast Notification
      function showToast(message, type = 'success') {
          const toast = document.createElement('div');
          toast.className = `toast ${type}`;
          toast.innerHTML = `
              <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
              <span>${message}</span>
          `;

          const container = document.getElementById('toastContainer');
          container.appendChild(toast);

          setTimeout(() => {
              toast.style.opacity = '0';
              toast.style.transform = 'translateX(100px)';
              setTimeout(() => container.removeChild(toast), 300);
          }, 3000);
      }

      // Filter and Search Functions
      document.getElementById('searchInput').addEventListener('input', filterPosts);
      document.getElementById('statusFilter').addEventListener('change', filterPosts);
      document.getElementById('sortFilter').addEventListener('change', sortPosts);

      function filterPosts() {
          const searchTerm = document.getElementById('searchInput').value.toLowerCase();
          const statusFilter = document.getElementById('statusFilter').value;
          const rows = document.querySelectorAll('.post-row');

          rows.forEach(row => {
              const title = row.querySelector('.post-title').textContent.toLowerCase();
              const content = row.querySelector('.post-meta').textContent.toLowerCase();
              const status = row.dataset.status;

              const matchesSearch = title.includes(searchTerm) || content.includes(searchTerm);
              const matchesStatus = statusFilter === 'all' || status === statusFilter;

              row.style.display = (matchesSearch && matchesStatus) ? '' : 'none';
          });
      }

      function sortPosts() {
          const sortBy = document.getElementById('sortFilter').value;
          const tbody = document.getElementById('postsTableBody');
          const rows = Array.from(tbody.querySelectorAll('.post-row'));

          rows.sort((a, b) => {
              if (sortBy === 'newest') {
                  return new Date(b.querySelector('td:nth-child(3) div').textContent) -
                         new Date(a.querySelector('td:nth-child(3) div').textContent);
              } else if (sortBy === 'oldest') {
                  return new Date(a.querySelector('td:nth-child(3) div').textContent) -
                         new Date(b.querySelector('td:nth-child(3) div').textContent);
              } else if (sortBy === 'title') {
                  return a.querySelector('.post-title').textContent.localeCompare(b.querySelector('.post-title').textContent);
              }
              return 0;
          });

          rows.forEach(row => tbody.appendChild(row));
      }

      // Utility Functions
      function refreshDashboard() {
          location.reload();
      }

      function exportData() {
          showToast('Export feature would generate CSV/PDF report here', 'info');
      }

      function editPost(postId) {
          showToast(`Edit post ${postId} - This would open edit modal in production`, 'info');
      }

      function showAllPosts() {
          document.getElementById('statusFilter').value = 'all';
          document.getElementById('searchInput').value = '';
          filterPosts();
      }

      function confirmDelete() {
          return confirm('Are you sure you want to delete this post? This action cannot be undone.');
      }

      function showUserMenu() {
          alert('User menu would open here with logout option');
      }

      // Initialize on page load
      document.addEventListener('DOMContentLoaded', function() {
          initializeChart();
          filterPosts();

          // Show notification for pending posts
          if ({{ pending_count|default:0 }} > 0) {
              setTimeout(() => {
                  showToast(`You have {{ pending_count|default:0 }} posts waiting for approval`, 'warning');
              }, 1000);
          }

          // Show welcome message
          setTimeout(() => {
              showToast('Welcome to Content Management Dashboard', 'success');
          }, 500);
      });

      // Real-time updates simulation
      setInterval(() => {
          const updates = document.querySelectorAll('.stat-change.positive');
          updates.forEach(update => {
              update.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> <span>Live updating...</span>';
              setTimeout(() => {
                  update.innerHTML = '<i class="fas fa-arrow-up"></i> <span>Updated just now</span>';
              }, 1000);
          });
      }, 30000);

      // Form submission handling
      document.getElementById('postForm')?.addEventListener('submit', function(e) {
          e.preventDefault();
          // Show success message
          showToast('Post created successfully!', 'success');
          // Close modal
          const modal = bootstrap.Modal.getInstance(document.getElementById('createPostModal'));
          modal.hide();
          // Submit form after delay
          setTimeout(() => {
              this.submit();
          }, 1500);
      });
    </script>
  </body>
</html>
